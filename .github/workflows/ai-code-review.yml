name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - '**.apex'
      - '**.cls'
      - '**.trigger'
      - '**.java'
      - '**.js'
      - '**.ts'
      - '**.py'
      - '**.go'
      - '**.cpp'
      - '**.c'
      - '**.cs'
      - '**.php'
      - '**.rb'
      - '**.swift'
      - '**.kt'
      - '**.scala'
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR Number (required for manual run)'
        required: true
        type: string
      branch:
        description: 'Branch name'
        required: false
        type: string
        default: 'main'

jobs:
  ai-code-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      
    steps:
      - name: Debug - Print Event Info
        run: |
          echo "=== è°ƒè¯•ä¿¡æ¯ ==="
          echo "äº‹ä»¶åç§°: ${{ github.event_name }}"
          echo "è§¦å‘æ–¹å¼: ${{ github.event_name == 'workflow_dispatch' && 'æ‰‹åŠ¨' || 'è‡ªåŠ¨' }}"
          
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "æ‰‹åŠ¨è¾“å…¥çš„PRå·: ${{ github.event.inputs.pr_number }}"
            echo "ç›®æ ‡åˆ†æ”¯: ${{ github.event.inputs.branch }}"
          else
            echo "PRå·: ${{ github.event.pull_request.number }}"
            echo "PRæ ‡é¢˜: ${{ github.event.pull_request.title }}"
          fi
          
      - name: Determine PR Number and Branch
        id: vars
        run: |
          # ç¡®å®šPRå·
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            PR_NUMBER="${{ github.event.inputs.pr_number }}"
            echo "ä½¿ç”¨æ‰‹åŠ¨è¾“å…¥çš„PRå·: $PR_NUMBER"
          else
            PR_NUMBER="${{ github.event.pull_request.number }}"
            echo "ä½¿ç”¨äº‹ä»¶ä¸­çš„PRå·: $PR_NUMBER"
          fi
          
          # ç¡®å®šåˆ†æ”¯
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            BRANCH="${{ github.event.inputs.branch }}"
          else
            BRANCH="${{ github.event.pull_request.head.ref }}"
          fi
          
          echo "PR_NUMBER=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "BRANCH=$BRANCH" >> $GITHUB_OUTPUT
          echo "REPO_NAME=${{ github.repository }}" >> $GITHUB_OUTPUT
          
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ steps.vars.outputs.BRANCH }}
          
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install zhipuai sniffio anyio httpx requests
          
      - name: Run AI Code Review
        env:
          ZHIPU_API_KEY: ${{ secrets.ZHIPU_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ steps.vars.outputs.PR_NUMBER }}
          REPO_NAME: ${{ steps.vars.outputs.REPO_NAME }}
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
        run: |
          echo "=== è¿è¡ŒAIä»£ç å®¡æŸ¥ ==="
          echo "PRå·: $PR_NUMBER"
          echo "ä»“åº“: $REPO_NAME"
          
          # è¿è¡Œå®¡æŸ¥è„šæœ¬
          python .github/scripts/ai_code_review.py
          
      - name: Upload Review Result
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ai-review-result-${{ github.run_number }}
          path: |
            review_result.md
          retention-days: 7
          
      - name: Comment PR (Auto Trigger)
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');
            const { PR_NUMBER, REPO_NAME } = process.env;
            
            console.log(`å°è¯•è¯„è®º PR #${PR_NUMBER} åœ¨ ${REPO_NAME}`);
            
            const reviewFilePath = path.join(process.env.GITHUB_WORKSPACE, 'review_result.md');
            
            if (fs.existsSync(reviewFilePath)) {
              try {
                const review = fs.readFileSync(reviewFilePath, 'utf8');
                console.log('âœ… æ‰¾åˆ°å®¡æŸ¥ç»“æœæ–‡ä»¶');
                
                // æäº¤è¯„è®º
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: parseInt(PR_NUMBER),
                  body: review
                });
                
                console.log(`âœ… æˆåŠŸæäº¤è¯„è®ºåˆ° PR #${PR_NUMBER}`);
              } catch (error) {
                console.error('âŒ æäº¤è¯„è®ºå¤±è´¥:', error.message);
              }
            } else {
              console.log('âŒ æœªæ‰¾åˆ°å®¡æŸ¥ç»“æœæ–‡ä»¶');
            }
            
      - name: Comment PR (Manual Trigger)
        if: github.event_name == 'workflow_dispatch' && always()
        uses: actions/github-script@v7
        env:
          PR_NUMBER: ${{ steps.vars.outputs.PR_NUMBER }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');
            const prNumber = process.env.PR_NUMBER;
            
            console.log(`[æ‰‹åŠ¨æ¨¡å¼] å°è¯•è¯„è®º PR #${prNumber}`);
            
            const reviewFilePath = path.join(process.env.GITHUB_WORKSPACE, 'review_result.md');
            
            if (fs.existsSync(reviewFilePath)) {
              try {
                const review = fs.readFileSync(reviewFilePath, 'utf8');
                console.log('âœ… æ‰¾åˆ°å®¡æŸ¥ç»“æœæ–‡ä»¶');
                
                // æäº¤è¯„è®º
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: parseInt(prNumber),
                  body: review
                });
                
                console.log(`âœ… æˆåŠŸæäº¤è¯„è®ºåˆ° PR #${prNumber}`);
              } catch (error) {
                console.error('âŒ æäº¤è¯„è®ºå¤±è´¥:', error.message);
                // åˆ›å»ºissueæ¥è®°å½•é”™è¯¯
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: `AI Review Error for PR #${prNumber}`,
                  body: `æ— æ³•æäº¤AIå®¡æŸ¥è¯„è®ºåˆ°PR #${prNumber}\n\né”™è¯¯: ${error.message}`
                });
              }
            } else {
              console.log('âŒ æœªæ‰¾åˆ°å®¡æŸ¥ç»“æœæ–‡ä»¶');
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: parseInt(prNumber),
                body: "ğŸ¤– AIä»£ç å®¡æŸ¥\n\næœ¬æ¬¡å®¡æŸ¥æœªç”Ÿæˆç»“æœï¼Œå¯èƒ½å› ä¸ºæ²¡æœ‰éœ€è¦å®¡æŸ¥çš„ä»£ç æ–‡ä»¶æˆ–æ–‡ä»¶è¿‡å¤§å·²è·³è¿‡å®¡æŸ¥ã€‚"
              });
            }
